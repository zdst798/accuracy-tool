<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全科正確率分析系統</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4a90e2; --success: #2ecc71; --danger: #e74c3c; --math: #ff7675; --physics: #74b9ff; --chemistry: #55efc4; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: #f0f4f8; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 600px; margin-bottom: 20px; }
        h2 { text-align: center; color: #2d3436; margin-bottom: 20px; }
        
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .full-row { grid-column: span 2; }
        
        label { display: block; font-size: 13px; color: #636e72; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 8px; box-sizing: border-box; font-size: 15px; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-calc { background: var(--primary); color: white; }
        .btn-calc:hover { background: #341f97; transform: translateY(-2px); }
        .btn-clear { background: #b2bec3; color: white; }

        .res-section { text-align: center; margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 10px; }
        #res-text { font-size: 36px; font-weight: bold; color: var(--primary); }
        
        .chart-container { width: 100%; height: 300px; margin-top: 10px; }

        .history-card { background: white; padding: 20px; border-radius: 16px; width: 100%; max-width: 600px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .history-list { list-style: none; padding: 0; margin-top: 10px; max-height: 250px; overflow-y: auto; }
        .history-item { display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        .subject-tag { padding: 3px 8px; border-radius: 5px; color: white; font-size: 12px; font-weight: bold; text-align: center; width: fit-content; }
        .tag-math { background: var(--math); }
        .tag-physics { background: var(--physics); }
        .tag-chemistry { background: var(--chemistry); }
    </style>
</head>
<body>

<div class="card">
    <h2>全科成績分析儀</h2>
    
    <div class="input-grid">
        <div class="input-box full-row">
            <label>姓名 / 備註</label>
            <input type="text" id="username" placeholder="請輸入姓名">
        </div>
        <div class="input-box">
            <label>選擇科目</label>
            <select id="subject">
                <option value="數學">數學</option>
                <option value="物理">物理</option>
                <option value="化學">化學</option>
            </select>
        </div>
        <div class="input-box">
            <label>總題數 / 總分</label>
            <input type="number" id="total" placeholder="0">
        </div>
        <div class="input-box full-row">
            <label>正確數 / 得分</label>
            <input type="number" id="correct" placeholder="0">
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-clear" onclick="resetForm()">重置</button>
        <button class="btn-calc" onclick="calculate()">儲存並分析</button>
    </div>

    <div class="res-section">
        <div style="font-size: 14px; color: #666;">本次正確率</div>
        <div id="res-text">--%</div>
    </div>

    <div class="chart-container">
        <canvas id="accuracyChart"></canvas>
    </div>
</div>

<div class="history-card">
    <h3>歷史數據庫 <button onclick="clearHistory()" style="float:right; color:var(--danger); border:none; background:none; cursor:pointer; font-size:12px;">清空全部</button></h3>
    <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr; font-size: 12px; color: #999; padding-bottom: 5px; border-bottom: 2px solid #eee;">
        <span>時間/姓名</span><span>科目</span><span>正確率</span><span>數值</span>
    </div>
    <ul id="history-list" class="history-list"></ul>
</div>

<script>
    let myChart;
    const ctx = document.getElementById('accuracyChart').getContext('2d');
    const colors = { '數學': '#ff7675', '物理': '#74b9ff', '化學': '#55efc4' };

    window.onload = () => {
        initChart();
        displayData();
    };

    function calculate() {
        const name = document.getElementById('username').value || "匿名";
        const subject = document.getElementById('subject').value;
        const total = parseFloat(document.getElementById('total').value);
        const correct = parseFloat(document.getElementById('correct').value);

        if (!total || total <= 0 || isNaN(correct)) {
            alert("請輸入正確的數值");
            return;
        }

        const rate = ((correct / total) * 100).toFixed(1);
        document.getElementById('res-text').innerText = rate + '%';
        
        saveData(name, subject, total, correct, rate);
        displayData();
        updateChart();
    }

    function saveData(name, subject, total, correct, rate) {
        let history = JSON.parse(localStorage.getItem('multi_subject_history') || '[]');
        history.push({
            time: new Date().toLocaleString([], {month: 'numeric', day: 'numeric', hour: '2-digit', minute:'2-digit'}),
            name: name,
            subject: subject,
            data: `${correct}/${total}`,
            rate: parseFloat(rate)
        });
        if (history.length > 20) history.shift(); 
        localStorage.setItem('multi_subject_history', JSON.stringify(history));
    }

    function displayData() {
        const history = JSON.parse(localStorage.getItem('multi_subject_history') || '[]');
        const list = document.getElementById('history-list');
        const tagMap = { '數學': 'tag-math', '物理': 'tag-physics', '化學': 'tag-chemistry' };
        
        list.innerHTML = history.slice().reverse().map(item => `
            <li class="history-item">
                <span style="font-size:12px;">${item.time}<br><b>${item.name}</b></span>
                <span><mark class="subject-tag ${tagMap[item.subject]}">${item.subject}</mark></span>
                <span style="font-weight:bold; color:${item.rate >= 60 ? 'var(--success)' : 'var(--danger)'}">${item.rate}%</span>
                <span style="color:#666; font-size:12px;">${item.data}</span>
            </li>
        `).join('');
    }

    function initChart() {
        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { min: 0, max: 100 } },
                plugins: { legend: { position: 'top' } }
            }
        });
        updateChart();
    }

    function updateChart() {
        const history = JSON.parse(localStorage.getItem('multi_subject_history') || '[]');
        const subjects = ['數學', '物理', '化學'];
        
        myChart.data.labels = [...new Set(history.map(h => h.time))];
        myChart.data.datasets = subjects.map(sub => {
            return {
                label: sub,
                data: history.map(h => h.subject === sub ? h.rate : null),
                borderColor: colors[sub],
                backgroundColor: colors[sub],
                tension: 0.3,
                spanGaps: true // 允許數據點不連續
            };
        });
        myChart.update();
    }

    function resetForm() {
        document.getElementById('total').value = '';
        document.getElementById('correct').value = '';
        document.getElementById('res-text').innerText = '--%';
    }

    function clearHistory() {
        if(confirm('確定清空所有數據嗎？')) {
            localStorage.removeItem('multi_subject_history');
            displayData();
            updateChart();
        }
    }
</script>

</body>
</html>
